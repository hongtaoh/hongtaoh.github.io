---

title: "æˆ‘æ˜¯å¦‚ä½•å‘æ˜ ANOVA çš„"
date: 2024-11-28
author: ç½—è´¹é›ª
slug: aov
draft: false
toc: true
tags: ç»Ÿè®¡

---

## ç¼˜èµ·

1921 å¹´ 5 æœˆ 12 æ—¥ï¼Œæˆ‘åœ¨è‹±æ ¼å…°çš„ä¸€å®¶å†œåœºæ•£æ­¥ã€‚å†œåœºä¸»å¬è¯´æˆ‘æ˜¯ä¸€åç§‘å­¦å®¶ï¼Œå‘æˆ‘è®¨è®ºèµ·ä»–æ­£åœ¨é€‰æ‹©åŒ–è‚¥çš„éš¾é¢˜ã€‚ä»–çš„å†œåœºç§äº† 12 å…¬é¡·çš„ç‰ç±³ï¼Œä½¿ç”¨äº†å››å®¶ä¸åŒåŒ–è‚¥å…¬å¸çš„äº§å“ï¼Œä»Šå¹´åˆšåˆšä¸°æ”¶ï¼Œä½†ä»–å´ä¸çŸ¥é“è¿™äº›åŒ–è‚¥æ˜¯å¦çœŸçš„æœ‰æ•ˆã€‚

æˆ‘è¢«è¿™ä¸€é—®é¢˜è¿·ä½äº†ã€‚æˆ‘ä»¬è‡ªç„¶å¯ä»¥ä½¿ç”¨ T æ£€éªŒï¼Œå¯¹æ¯ä¸€ç§å¯èƒ½çš„äº§å“å¯¹è¿›è¡Œå¯¹æ¯”ï¼Œä½†è¿™ç§æ–¹æ³•æ¯”è¾ƒæ…¢ã€‚å¦‚æœå†œåœºä¸»åªæ˜¯æƒ³çŸ¥é“è¿™å››ç§ä¸åŒåŒ–è‚¥æ˜¯å¦æ•ˆç”¨ç›¸åŒï¼Œé‚£æ˜¯å¦æœ‰æ›´å¿«çš„æ–¹æ³•ï¼Ÿ

æˆ‘è‡ªç„¶å¼€å§‹ç”¨æˆ‘çš„æ‹¿æ‰‹å¥½æˆï¼šå‡è®¾æ£€éªŒã€‚å¦‚æœå››ç§åŒ–è‚¥æ•ˆç”¨ç›¸åŒï¼Œç»“æœä¼šæ€æ ·ï¼Ÿ

å¦‚æœåŒ–è‚¥æ•ˆç”¨ç›¸åŒï¼Œåˆ™å¯è§†ä¸ºæˆ‘ä»¬ä»ä¸€ä¸ªæ€»ä½“ä¸­éšæœºæŠ½å–äº†å››ä»½æ ·æœ¬ã€‚é’ˆå¯¹è¿™å››ä»½æ ·æœ¬ï¼Œæˆ‘ä»¬æœ‰ä»¥ä¸‹å‡ ä¸ªè¯¯å·®ï¼š

- å››ä¸ªæ ·æœ¬å„è‡ªçš„å‡å€¼ä¸æ ·æœ¬æ€»å‡å€¼çš„è¯¯å·®
- å„è‡ªæ ·æœ¬å†…éƒ¨ï¼Œæ¯ä¸ªæ•°æ®ç‚¹ä¸å„è‡ªæ‰€åœ¨æ ·æœ¬çš„å‡å€¼ä¹‹é—´çš„è¯¯å·®ã€‚

ç”¨ `$N$` è¡¨ç¤ºæ•°æ®æ€»é‡ï¼Œ`$K$` è¡¨ç¤ºæœ‰å¤šå°‘ç§ä¸åŒæ ·æœ¬ï¼Œåœ¨è¿™é‡Œæ˜¯ 4ã€‚

`$N_i$` è¡¨ç¤ºç¬¬ `$i$` ä¸ªæ ·æœ¬çš„æ•°æ®é‡ï¼Œ`$\bar{X}$` è¡¨ç¤ºæ‰€æœ‰æ ·æœ¬çš„æ€»å‡å€¼ï¼Œ`$\bar{X_i}$` è¡¨ç¤ºç¬¬ `$i$` ä¸ªæ ·æœ¬çš„å‡å€¼ï¼Œ`$S^2_i$` è¡¨ç¤ºç¬¬ `$i$` ä¸ªæ ·æœ¬çš„æ–¹å·®

ã€Œå››ä¸ªæ ·æœ¬å„è‡ªçš„å‡å€¼ä¸æ ·æœ¬æ€»å‡å€¼çš„è¯¯å·®ã€æˆ‘ä»¬è®°ä¸º SSTrtï¼Œè®¡ç®—æ–¹æ³•å¦‚ä¸‹ï¼š

`$$
\text{SSTrt} = \sum_{i=1}^K N_i \cdot \left( \bar{X_i} - \bar{X} \right)^2
$$`

ã€Œå„è‡ªæ ·æœ¬å†…éƒ¨ï¼Œæ¯ä¸ªæ•°æ®ç‚¹ä¸å„è‡ªæ‰€åœ¨æ ·æœ¬çš„å‡å€¼ä¹‹é—´çš„è¯¯å·®ã€è®°ä¸º SSErrï¼Œè®¡ç®—æ–¹æ³•å¦‚ä¸‹ï¼š

`$$
\text{SSErr} = \sum_{i=1}^K (N_i - 1) \cdot S^2_i
$$`

è¿™æ ·æ±‚å‡ºæ¥çš„å€¼æ²¡åŠæ³•ç›´æ¥æ¯”è¾ƒï¼Œå› ä¸º `$N$` ä¸ `$K$` å¯èƒ½ä¸æ˜¯ä¸€ä¸ªæ•°é‡çº§ï¼Œéœ€è¦æƒ³ä¸€ä¸ªåŠæ³•æ±‚å¹³å‡å€¼ã€‚æˆ‘ä»¬è¿™é‡Œé™¤ä»¥å„è‡ªçš„è‡ªç”±åº¦ï¼Œè€Œä¸æ˜¯ç›´æ¥é™¤ä»¥ `$N$` ä¸ `$K$`ï¼Œè‡³äºä¸ºä»€ä¹ˆï¼Œä¹‹åå†ç»†èŠã€‚è¿™æ ·ç®—å‡ºæ¥çš„æ•°æˆ‘ä»¬ç§°ä¸º MSTrt å’Œ MSErrã€‚

`$$
\text{MSTrt} = \frac{\text{SSTrt}}{K-1}
$$`

`$$
\text{MSErr} = \frac{\text{SSErr}}{N-K}
$$`

æœ€åçš„é‡å¤´æˆæ˜¯æˆ‘ä»¬æƒ³æ¯”è¾ƒä¸€ä¸‹è¿™ä¸¤è€…ï¼Œå–å…¶å•†ï¼š

`$$
F = \frac{\text{MSTrt}}{\text{MSErr}}
$$`

æˆ‘å›åˆ°å®¶ï¼Œç«‹é©¬ç”¨æœªæ¥ä¸–ç•Œé‡Œçš„ Python è¿›è¡Œæ¨¡æ‹Ÿã€‚æ¨¡æ‹Ÿçš„æ–¹æ³•æ˜¯è¿™æ ·ï¼šä¸€ä¸ªå…­é¢çš„éª°å­ğŸ²ï¼ŒéšæœºæŠ›æ·ä¸€ä¸‡æ¬¡ï¼Œæ¯æ¬¡è®°å½•å…¶é¢å€¼ã€‚ç„¶åå°†æ­¤ä¸€ä¸‡ä¸ªæ•°å¹³å‡åˆ†ä¸ºå››ç»„ï¼š


```python
import numpy as np 
import pandas as pd

np.random.seed(42)
rolls = np.random.randint(1, 7, size = 10000)
np.random.shuffle(rolls)
```


```python
# Divide rolls into four groups randomly
group_size = len(rolls) // 4
group1 = rolls[:group_size]
group2 = rolls[group_size:2*group_size]
group3 = rolls[2*group_size:3*group_size]
group4 = rolls[3*group_size:]

group_dic = {'A': group1, 'B': group2, 'C': group3, 'D': group4}
```


```python
def calc(group_dic):
    res = []
    for group, data in group_dic.items():
        mu = np.mean(data)
        n = len(data)
        var = np.var(data, ddof = 1)
        res.append({
            'treatment': group,
            'sample_mean': mu,
            'sample_variance': var,
            'sample_size': n
        })
    return res

res = calc(group_dic)
res = pd.DataFrame(res)
res
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>treatment</th>
      <th>sample_mean</th>
      <th>sample_variance</th>
      <th>sample_size</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>A</td>
      <td>3.4796</td>
      <td>2.977975</td>
      <td>2500</td>
    </tr>
    <tr>
      <th>1</th>
      <td>B</td>
      <td>3.4692</td>
      <td>2.952632</td>
      <td>2500</td>
    </tr>
    <tr>
      <th>2</th>
      <td>C</td>
      <td>3.5276</td>
      <td>2.843976</td>
      <td>2500</td>
    </tr>
    <tr>
      <th>3</th>
      <td>D</td>
      <td>3.5232</td>
      <td>2.905024</td>
      <td>2500</td>
    </tr>
  </tbody>
</table>
</div>




```python
n = res.sample_size.sum()
k = len(group_dic)
n, k
```




{{< indentedblock >}}
(10000, 4)
{{< /indentedblock >}}
```python
grand_mean = np.sum(
    res['sample_mean'] * res['sample_size'])/n
grand_mean
```




{{< indentedblock >}}
3.4999
{{< /indentedblock >}}
```python
sstrt = np.sum(
    res['sample_size']*(res['sample_mean'] - grand_mean)**2)
sstrt
```




{{< indentedblock >}}
6.661900000000044
{{< /indentedblock >}}
```python
sserr = np.sum(
    (res.sample_size -1)*res.sample_variance
)
sserr
```




{{< indentedblock >}}
29187.338
{{< /indentedblock >}}
```python
dftot = n-1
dftrt = k-1
dferr = n-k
mstrt = sstrt/dftrt
mserr = sserr/dferr
mstrt, mserr
```




{{< indentedblock >}}
(2.220633333333348, 2.9199017607042816)
{{< /indentedblock >}}
```python
f_value = mstrt/mserr
f_value
```




{{< indentedblock >}}
0.7605164540870478
{{< /indentedblock >}}
## ä¸€ä¸‡æ¬¡æ‚²ä¼¤

ä¸Šé¢æˆ‘ä»¬åªæ˜¯è¯•äº†ä¸€æ¬¡ï¼Œè®©æˆ‘è¯•ä¸€ä¸‡æ¬¡ï¼Œå–ä¸€ä¸‡ä¸ª `$F$`ï¼Œçœ‹çœ‹åˆ†å¸ƒå¦‚ä½•ï¼š


```python
def get_group_dic(start, end, size, k):
    # Generate random rolls
    rolls = np.random.randint(start, end + 1, size=size)
    np.random.shuffle(rolls)

    # Calculate group size
    group_size = len(rolls) // k
    remainder = len(rolls) % k  # To handle leftover elements

    # Create groups dynamically
    group_dic = {}
    start_idx = 0
    for i in range(k):
        # Determine the size of the current group
        current_group_size = group_size + (1 if i < remainder else 0)
        group_dic[chr(65 + i)] = rolls[start_idx:start_idx + current_group_size]
        start_idx += current_group_size

    return group_dic

def calc_f(group_dic):
    res = calc(group_dic)
    res = pd.DataFrame(res)
    n = res.sample_size.sum()
    k = len(group_dic)
    grand_mean = np.sum(res['sample_mean'] * res['sample_size'])/n
    sstrt = np.sum(res['sample_size']*(res['sample_mean'] - grand_mean)**2)
    sserr = np.sum((res.sample_size -1)*res.sample_variance)
    dftrt = k-1
    dferr = n-k
    mstrt = sstrt/dftrt
    mserr = sserr/dferr
    f_value = mstrt/mserr
    return f_value
```


```python
attempt = 10000
f_values = []
for _ in range(attempt):
    group_dic = get_group_dic(1, 7, 10000, 4)
    f = calc_f(group_dic)
    f_values.append(f)
```


{{< codeCollapse >}}

import matplotlib.pyplot as plt

# Plot the histogram
plt.figure(figsize=(8, 6))
plt.hist(f_values, bins=50, density=True, alpha=0.75, edgecolor='black', label='Histogram')

# Optional: Add a density line using a kernel density estimate
from scipy.stats import gaussian_kde
density = gaussian_kde(f_values)
x_vals = np.linspace(min(f_values), max(f_values), 1000)
plt.plot(x_vals, density(x_vals), label='Density', linewidth=2)

# Customize the plot
plt.title('Distribution of F Values', fontsize=16)
plt.xlabel('F', fontsize=14)
plt.ylabel('Density', fontsize=14)
plt.legend()
plt.grid(alpha=0.3)
plt.show()

{{< /codeCollapse >}}


![png](/cn/blog/2024-11-28-anova_files/2024-11-28-anova_14_0.png)


## ä¸åŒçš„ `$N$` ä¸ `$K$`

è®¾ `$N = 3000$`ï¼Œ`$K = 10$`


```python
f_values = []
for _ in range(attempt):
    group_dic = get_group_dic(1, 7, 3000, 10)
    f = calc_f(group_dic)
    f_values.append(f)
```


{{< codeCollapse >}}

import matplotlib.pyplot as plt

# Plot the histogram
plt.figure(figsize=(8, 6))
plt.hist(f_values, bins=50, density=True, alpha=0.75, edgecolor='black', label='Histogram')

# Optional: Add a density line using a kernel density estimate
from scipy.stats import gaussian_kde
density = gaussian_kde(f_values)
x_vals = np.linspace(min(f_values), max(f_values), 1000)
plt.plot(x_vals, density(x_vals), label='Density', linewidth=2)

# Customize the plot
plt.title('Distribution of F Values', fontsize=16)
plt.xlabel('F', fontsize=14)
plt.ylabel('Density', fontsize=14)
plt.legend()
plt.grid(alpha=0.3)
plt.show()
{{< /codeCollapse >}}


![png](/cn/blog/2024-11-28-anova_files/2024-11-28-anova_17_0.png)


## ç»“è®ºä¸æœªç«Ÿäº‹å®œ

ç»“è®ºå°±æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬çŸ¥é“ `$N$` ä¸ `$K$`ï¼Œé‚£ä¹ˆå°±å¯ä»¥é€šè¿‡å¯¹æ¯”ä¸Šé¢çš„å›¾ï¼ŒçŸ¥é“ `$H_0: \mu_1 = \mu_2 = ... \mu_K$` æ˜¯å¦æˆç«‹ã€‚

ä½†æ˜¯æœ‰å‡ ä¸ªç‚¹æˆ‘è¿˜æ²¡ææ¸…æ¥šï¼š

- ä¸ºä»€ä¹ˆ F çš„æœŸæœ›å€¼æ˜¯ 1ï¼Œå› æ­¤ F æ£€éªŒæ˜¯ä¸€ä¸ªå•å°¾æ£€æµ‹ï¼Ÿ
- ä¸Šé¢çš„æ¨¡æ‹Ÿæˆ‘æ²¡æœ‰è€ƒè™‘å„ç»„æ ·æœ¬é‡ä¸åŒçš„æƒ…å†µï¼Œå¦‚ä½•è¯æ˜å…¶ä¸å½±å“æœ€åçš„ç»“æœï¼Ÿ
- éœ€è¦ä¸¥è°¨çš„æ•°å­¦è¯æ˜æ¥æ¨å¯¼å‡ºåœ¨å·²çŸ¥ä¸¤ä¸ªæ—¢å®šè‡ªç”±åº¦æƒ…å†µä¸‹ï¼ŒF åˆ†å¸ƒçš„ PDF ä¸ CDF çš„ç²¾ç¡®å…¬å¼ã€‚è¿™æ ·å°±ä¸ç”¨æ¯æ¬¡éƒ½æ¨¡æ‹Ÿï¼Œè€Œä¸”æ›´ä¸ºç²¾ç¡®ã€‚

è¿™äº›å·¥ä½œå°±è®©æˆ‘çš„å­¦ç”Ÿ [Ronald Fisher](https://en.wikipedia.org/wiki/Ronald_Fisher) æ¥å®Œæˆå§ã€‚ 
